CC = gcc
CFLAGS_BASE = -Wall -Wextra -Iinclude -g
CFLAGS_OPT = -O2
CFLAGS = $(CFLAGS_BASE) $(CFLAGS_OPT) -std=c99
LDFLAGS = -lm

# Directories
SRC_DIR = src
OBJ_DIR = obj
BIN_DIR = bin
DATA_DIR = data
PLOTS_DIR = plots
SCRIPT_DIR = scripts
LATEX_DIR = latex_out
INCLUDE_DIR = include

# Source and object files
SOURCES = $(wildcard $(SRC_DIR)/*.c)
OBJECTS = $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(SOURCES))
HEADERS = $(wildcard $(INCLUDE_DIR)/*.h)

EXECUTABLE = $(BIN_DIR)/tridiagonal_solver

.PHONY: all directories run plots tables clean distclean help

all: directories $(EXECUTABLE)

directories:
	@echo "Creating directories..."
	@mkdir -p $(OBJ_DIR) $(BIN_DIR) $(DATA_DIR) $(PLOTS_DIR) $(SCRIPT_DIR) $(LATEX_DIR)

$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c $(HEADERS)
	@echo "Compiling $< -> $@"
	$(CC) $(CFLAGS) -c $< -o $@

$(EXECUTABLE): $(OBJECTS)
	@echo "Linking $^ -> $@"
	$(CC) $(OBJECTS) -o $@ $(LDFLAGS)

run: all
	@echo "Running $(EXECUTABLE)..."
	./$(EXECUTABLE)
	@echo "Program finished."

plots: run
	@echo "Generating plots using Gnuplot..."
	@# plot_tridiag_* is an adjusted pattern
	@for gp_script in $(wildcard $(SCRIPT_DIR)/plot_tridiag_*.gp); do \
		echo "  Executing Gnuplot script: $$gp_script"; \
		gnuplot "$$gp_script" || echo "  Gnuplot failed for $$gp_script"; \
	done
	@echo "Plot generation finished. Check $(PLOTS_DIR)/ directory."

tables: run
	@echo "LaTeX tables generated in $(LATEX_DIR)/ directory by the C program."
	@echo "Compile them with a LaTeX distribution (e.g., pdflatex your_report.tex)."

# Missaligned comments in the command below might seem like an error but they are made so that it looks corrent in the terminal

clean:
	@echo "Cleaning temporary and generated files..."
	rm -f $(OBJ_DIR)/*.o
	rm -f $(EXECUTABLE)
	rm -f $(DATA_DIR)/tridiag_*.csv       		# Adjusted pattern
	rm -f $(PLOTS_DIR)/tridiag_*.png      		# Adjusted pattern
	rm -f $(SCRIPT_DIR)/plot_tridiag_*.gp 	# Adjusted pattern
	rm -f $(LATEX_DIR)/table_tridiag_*.tex 	# Adjusted pattern
	@echo "Cleaning finished."

distclean: clean
	@echo "Removing all generated directories..."
	rm -rf $(OBJ_DIR) $(BIN_DIR) $(DATA_DIR) $(PLOTS_DIR) $(SCRIPT_DIR) $(LATEX_DIR)
	@echo "Distclean finished."

help:
	@echo "Available commands:"
	@echo "  make all        - Compiles the program (default)"
	@echo "  make run        - Compiles and runs the program"
	@echo "  make plots      - Compiles, runs, and then executes Gnuplot scripts"
	@echo "  make tables     - Compiles and runs (tables generated by C program)"
	@echo "  make clean      - Removes temporary and generated output files"
	@echo "  make distclean  - Performs 'clean' and removes generated directories"