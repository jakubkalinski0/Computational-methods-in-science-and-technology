# Compiler and flags
CC = gcc
CFLAGS = -Wall -Wextra -O3 -Iinclude -g # Optimization L3, include path, debug info
LDFLAGS = -lm # Link math library
PYTHON = python3 # Define Python interpreter

# Directories
SRC_DIR = src
OBJ_DIR = obj
BIN_DIR = bin
DATA_DIR = data
PLOTS_DIR = plots
SCRIPT_DIR = scripts

# Source and object files for trigonometric approximation (direct method)
SOURCES = $(SRC_DIR)/approximation.c \
          $(SRC_DIR)/error.c \
          $(SRC_DIR)/fileio.c \
          $(SRC_DIR)/function.c \
          $(SRC_DIR)/linear_algebra.c \
          $(SRC_DIR)/main.c \
          $(SRC_DIR)/nodes.c
OBJECTS = $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(SOURCES))
# Executable name reflects the method (optional, but clearer)
EXECUTABLE = $(BIN_DIR)/trig_approx_direct_app

# --- Generated Files ---
# Data generated by C program
# Updated CSV filename for the direct method
HEATMAP_DATA = $(DATA_DIR)/trig_approx_direct_heatmap_errors.csv
ORIGINAL_PLOT_DATA = $(DATA_DIR)/original_function_plot.dat
# .dat files for individual approximations (trig_approx_m*) and samples (sample_points_n*) also generated.

# Script generated by C program (name remains the same conceptually)
INDIVIDUAL_APPROX_SCRIPT = $(SCRIPT_DIR)/plot_all_trig_approximations.gp

# Python script for heatmap plotting (in SRC_DIR)
PYTHON_PLOT_SCRIPT = $(SRC_DIR)/plot_heatmaps.py

# Plot files generated by Python script (uses OUTPUT_FORMAT variable)
# Define desired output format for Python plots (used mainly for target names)
OUTPUT_FORMAT = svg # Change to png or pdf if desired (match Python script's setting)
# Updated plot filenames to reflect direct method and parameters
PY_MAX_ERR_PLOT = $(PLOTS_DIR)/trig_direct_max_error_heatmap.$(OUTPUT_FORMAT)
PY_MSE_PLOT = $(PLOTS_DIR)/trig_direct_mse_heatmap.$(OUTPUT_FORMAT)
PY_ANN_MAX_ERR_PLOT = $(PLOTS_DIR)/annotated_trig_direct_max_error_heatmap.$(OUTPUT_FORMAT)
PY_ANN_MSE_PLOT = $(PLOTS_DIR)/annotated_trig_direct_mse_heatmap.$(OUTPUT_FORMAT)
# Define primary targets for Python plots rule
PY_PLOTS = $(PY_MAX_ERR_PLOT) $(PY_MSE_PLOT)

# Default rule: build the executable
all: directories $(EXECUTABLE)

# Create necessary directories
directories:
	@mkdir -p $(OBJ_DIR) $(BIN_DIR) $(DATA_DIR) $(PLOTS_DIR) $(SCRIPT_DIR)

# Compile object files (Dependency list uses wildcard for headers)
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c $(wildcard include/*.h)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) -c $< -o $@

# Link the program
$(EXECUTABLE): $(OBJECTS)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)

# --- Data Generation and Plotting ---

# Target to run the C program (generates CSV, DATs, GP script)
run: $(EXECUTABLE) $(HEATMAP_DATA) $(ORIGINAL_PLOT_DATA) $(INDIVIDUAL_APPROX_SCRIPT)

# Rule showing how the primary outputs are generated
$(HEATMAP_DATA) $(ORIGINAL_PLOT_DATA) $(INDIVIDUAL_APPROX_SCRIPT): $(EXECUTABLE)
	@echo "Running C program $(EXECUTABLE) to generate trigonometric (direct method) data and plot script..."
	@./$(EXECUTABLE)


# Target to generate heatmap plots using the Python script.
py_plots: $(PYTHON_PLOT_SCRIPT) $(HEATMAP_DATA) $(PY_PLOTS)

# Rule to generate plots using Python. Lists main output files as targets.
$(PY_PLOTS): $(PYTHON_PLOT_SCRIPT) $(HEATMAP_DATA)
	@echo "Generating trigonometric (direct method) heatmap plots using Python script..."
	$(PYTHON) $(PYTHON_PLOT_SCRIPT) # Runs the python script


# Target to generate ALL individual trigonometric approximation plots using Gnuplot.
generate_individual_plots: $(INDIVIDUAL_APPROX_SCRIPT) $(ORIGINAL_PLOT_DATA)
	@echo "Generating all individual trigonometric approximation plots using Gnuplot (m < n/2)..."
	@gnuplot $(INDIVIDUAL_APPROX_SCRIPT)


# The main 'plots' target: runs C code, then Python, then Gnuplot
plots: run py_plots generate_individual_plots
	@echo ""
	@echo "--- Plot Generation Summary (Trigonometric - Direct Method) ---"
	@echo "Generated CSV data file:"
	@ls -l $(HEATMAP_DATA) 2>/dev/null || echo "  $(HEATMAP_DATA) not found."
	@echo "Generated Heatmap plots (Python, format: .$(OUTPUT_FORMAT)):"
	@ls -l $(PLOTS_DIR)/trig_direct_*.$(OUTPUT_FORMAT) $(PLOTS_DIR)/annotated_trig_direct_*.$(OUTPUT_FORMAT) 2>/dev/null || echo "  No Python heatmap plots found in $(PLOTS_DIR) with format .$(OUTPUT_FORMAT)."
	@echo "Generated Individual plots (Gnuplot, format: .png):"
	@ls -l $(PLOTS_DIR)/trig_approx_m*.png 2>/dev/null || echo "  No Gnuplot individual plots found in $(PLOTS_DIR)."
	@echo "---------------------------------------------------------------"
	@echo "Plot generation finished. Check the '$(PLOTS_DIR)' directory."


# --- Cleaning ---

clean:
	@echo "Cleaning temporary files and generated outputs..."
	rm -f $(OBJ_DIR)/*.o
	rm -f $(EXECUTABLE)
	rm -f $(DATA_DIR)/*.csv $(DATA_DIR)/*.dat
	# Remove all generated plots regardless of format
	rm -f $(PLOTS_DIR)/*.*
	rm -f $(SCRIPT_DIR)/*.gp
	@echo "Cleaning finished."

distclean: clean
	@echo "Removing all generated directories..."
	rm -rf $(OBJ_DIR) $(BIN_DIR) $(DATA_DIR) $(PLOTS_DIR) $(SCRIPT_DIR)
	@echo "Deep cleaning finished."

# --- Help ---

help:
	@echo "Available commands for Trigonometric Approximation (Direct Method):"
	@echo "  make all          - Compiles the C trigonometric approximation program (default)"
	@echo "  make run          - Compiles and runs the C program to generate data (.csv, .dat) and Gnuplot script (.gp)"
	@echo "  make py_plots     - Runs the Python script (src/plot_heatmaps.py) to generate heatmap plots (requires data from 'make run')"
	@echo "  make generate_individual_plots - Runs Gnuplot to generate individual plots (requires script/data from 'make run')"
	@echo "  make plots        - Runs 'make run', then generates all Python heatmaps and Gnuplot individual plots"
	@echo "  make clean        - Removes object files, executable, generated data, plots, and scripts"
	@echo "  make distclean    - Performs 'clean' and removes generated directories"
	@echo "  make help         - Displays this help message"

# Declare phony targets
.PHONY: all directories run plots py_plots generate_individual_plots clean distclean help